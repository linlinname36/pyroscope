#summary PyroScope software update procedures.
#labels installation,configuration

<wiki:toc />

= Making backups =
Since repairing broken files resulting from faulty updates usually is either a lot of work or simply impossible, always *make a backup*. Backups should be made when _either_ PyroScope or rTorrent is changed to a new version or SVN revision.

These steps should make a copy of pretty much anything important:
 1. Copy your rTorrent session data (rTorrent needs to be running): 
{{{
rtxmlrpc -q session_save
tar cvfz /tmp/session-backup-$(date +'%Y-%m-%d').tgz $(echo $(rtxmlrpc get_session)/ | tr -s / /)*.torrent
}}}
 1. Backup your current PyroScope virtualenv and configuration:
{{{
tar cvfz /tmp/pyroscope-$(date +'%Y-%m-%d').tgz  ~/.pyroscope/ ~/lib/pyroscope/
}}}
 1. Depending on how you install rTorrent, make a copy of the rTorrent executable. Note that the `rTorrent-PS` build script installs into versioned directories, i.e. using that you don't have to worry if changing the rTorrent version ­— the old one is still available.


= Updating the software =
*Before* adapting and extending your configuration to make use of new features, you first have to update the software itself. How to do that depends on the way you initially installed it, so follow *one* of the following sections, depending on whether you did a release installation or one from source.


== How to do a release version software update ==

Remember to read the *migration instructions* further below, and the [http://code.google.com/p/pyroscope/source/browse/trunk/debian/changelog changelog], BEFORE installing any new version*.

Then to *update* an existing installation, use this command *if* you used the instructions on the InstallReleaseVersion page:
{{{
sudo easy_install --prefix /usr/local -U pyrocore
}}}

*Otherwise*, in case you followed InstallToPythonVirtualenv, use this *instead*:
{{{
~/lib/pyroscope/bin/easy_install -U pyrocore
ln -nfs $(grep -l 'entry_point.*pyrocore==' ~/lib/pyroscope/bin/*) ~/bin/
}}}

Now *skip* the next section describing a source installtion upgrade, and go to the configuration update further below.


== How to update a source installation to the newest code ==

*BEFORE* any update, remember to read the *migration instructions* further below, the *[http://code.google.com/p/pyroscope/source/browse/trunk/debian/changelog changelog]* and the *[http://code.google.com/p/pyroscope/source/list SVN log].*

Then to *update* an existing installation, use these commands:
 {{{
cd ~/lib/pyroscope
svn update
./update-to-head.sh
}}}


= Updating your existing configuration for a new software version =

After you installed a new version of the software, you can easily check whether the default configuration files changed by calling the `pyroadmin --create-config` command. Since this will never overwrite existing configuration files, the files `config.ini.default` and `config.py.default` will be created instead.

You can then use the `diff` tool to check for the differences between your current configuration and the new default one, and add any changes you want to adopt. Also note that sections of the configuration you leave out, and keys that you do not overwrite, are automatically taken from the defaults, which greatly simplifies any update — so having a minimal configuration with just the changes and additions you actually want is recommended.

And remember to *always read the [http://pyroscope.googlecode.com/svn/trunk/debian/changelog changelog]*!

== Migrating to version 0.3.4 ==
*NOTE: These instructions also apply if you freshly installed version 0.3.4 or higher!*

To fully make use of the new features, you need to do the following:
  # Read and follow the section _Extending your `.rtorrent.rc`_ on the UserConfiguration page and restart rTorrent.
  # To add the new custom keys to your existing session data, call these commands in a shell: 
{{{
# Make a full, current backup of the session data
rtxmlrpc -q session_save
tar cvfz ~/session-backup-0.3.4.tgz $(echo $(rtxmlrpc get_session)/ | tr -s / /)*.torrent

# Set missing "loaded" times to that of the .torrent file
rtcontrol '!*"*' loaded=0 -q -sname -o 'echo "$(name)s"\ntest -f "$(metafile)s" && rtxmlrpc -q d.set_custom $(hash)s tm_loaded \$(\
    ls -l --time-style "+%%s" "$(metafile)s" \
    | cut -f6 -d" ")\nrtxmlrpc -q d.save_session $(hash)s' | bash

# Set missing "completed" times to that of the data file or directory
rtcontrol '!*"*' completed=0 path=\! is_ghost=no -q -sname -o 'echo "$(name)s"\ntest -e "$(realpath)s" && rtxmlrpc -q d.set_custom $(hash)s tm_completed \$(\
    ls -ld --time-style "+%%s" "$(realpath)s" \
    | cut -f6 -d" ")\nrtxmlrpc -q d.save_session $(hash)s' | bash
}}}
  # Call `pyroadmin --create-config` and check your `config.ini` against `config.ini.default` as described above. Among other things, the default `output_format` has changed.
  # The command "`rtcontrol completed=-1d -scompleted`" should now show your completed downloads of the last 24 hours, in order.
  # Enjoy.

== Migrating to version 0.3.6 ==
To fully make use of the new features, you need to change your rTorrent configuration and execute a few commands. Users that did *not* yet follow the 0.3.4 migration instructions should do so *first*.

*NOTE: These instructions also apply if you freshly installed version 0.3.6 or higher!*

After you're "on the 0.3.4 level", this will get you ready for 0.3.6:
  # Make a full, current backup of the session data:
{{{
rtxmlrpc -q session_save
tar cvfz ~/session-backup-0.3.6.tgz $(echo $(rtxmlrpc get_session)/ | tr -s / /)*.torrent
}}}
  # Read and follow the section _Extending your `.rtorrent.rc`_ on the UserConfiguration page and restart rTorrent. Users that already added the extensions for previous versions should replace the relevant parts of their configuration with the new snippets.
  # Call `pyroadmin --create-config` and check your `config.ini` against `config.ini.default` as described above. Among other things, some output formats have changed.
  # The command "`rtcontrol \* -qostarted | sort | uniq -c`" should now, for the majority of your torrents, show the start time of rTorrent after adding the `tm_started` configuration bits (cf. step 2, stopped ones will get counted under `1970-01-01`).
  # Assuming you have incomplete torrents, "`rtcontrol is_complete=0 -ostarted.raw.delta,leechtime,name --column-headers`" should show identical values in the `STARTED` and `LEECHTIME` columns.
  # Enjoy.


== Migrating to version 0.4.1 ==
There is a new dependency on the `pyrobase` package, and for *release version installations*, it will be managed transparently — you have nothing to worry about, just follow the updating instructions from InstallReleaseVersion, and then see below for the required steps after updating.

On the other hand, if you have an *installation from source*, it's important that you add the new dependency _also_ from source, because otherwise your installation will break during further development (since then, you'd remain on the _released_ version of `pyrobase`). So, call these commands (assuming the standard installation paths):
{{{
cd ~/lib/pyroscope
source bin/activate
svn update
git clone git://github.com/pyroscope/pyrobase.git pyrobase
( cd pyrocore && source bootstrap.sh )
}}}

In addition, follow these steps:
 # You *must* add the new `startup_time` command, and you _should_ add the `cull` command (see "Extending your `.rtorrent.rc`" on the UserConfiguration page).
 # Call `pyroadmin --create-config` to add the new builtin [OutputTemplates Tempita templates] to your configuration.
 # To get bash completion for the PyroScope commands, see the instructions on the BashCompletion page.


== Migrating to version 0.4.2 ==

 # *TODO* config include
 # *TODO* new `update-to-head.sh` script
 # *TODO* extended version
 # *TODO* 0.8.7 support, RtXmlRpcMigration